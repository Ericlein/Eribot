name: Security

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write  # Required for OpenSSF Scorecard

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping"
          fi
          pip install safety pip-audit

      - name: Run Python safety check
        run: |
          safety check --json --output safety-report.json || echo "Safety check completed with warnings"

      - name: Run pip-audit
        run: |
          pip-audit --format=json --output=pip-audit-report.json || echo "Pip-audit completed with warnings"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
        continue-on-error: true

      - name: Restore .NET dependencies
        run: |
          if [ -d "csharp_remediator" ]; then
            cd csharp_remediator
            dotnet restore || echo "Dotnet restore failed"
          else
            echo "csharp_remediator directory not found, skipping .NET steps"
          fi

      - name: Check .NET vulnerabilities
        run: |
          if [ -d "csharp_remediator" ]; then
            cd csharp_remediator
            dotnet list package --vulnerable --include-transitive --format json > ../dotnet-vulnerabilities.json || echo "No .NET vulnerabilities found"
          else
            echo "{}" > dotnet-vulnerabilities.json
          fi

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            safety-report.json
            pip-audit-report.json
            dotnet-vulnerabilities.json
        if: always()

  secret-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./ 
          base: main
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

  vulnerability-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-filesystem'
        continue-on-error: true

      - name: Build and scan Docker images with Trivy
        run: |
          if [ -f "docker/Dockerfile.python" ]; then
            docker build -f docker/Dockerfile.python -t eribot-monitor:latest . || echo "Python Docker build failed"
            if docker images | grep -q eribot-monitor; then
              docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v ${{ github.workspace }}:/workspace aquasec/trivy:latest image --format sarif --output /workspace/trivy-docker-monitor.sarif eribot-monitor:latest || echo "Trivy scan failed"
            fi
          else
            echo "docker/Dockerfile.python not found, skipping"
          fi

          if [ -f "docker/Dockerfile.csharp" ]; then
            docker build -f docker/Dockerfile.csharp -t eribot-remediator:latest . || echo "C# Docker build failed"
            if docker images | grep -q eribot-remediator; then
              docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v ${{ github.workspace }}:/workspace aquasec/trivy:latest image --format sarif --output /workspace/trivy-docker-remediator.sarif eribot-remediator:latest || echo "Trivy scan failed"
            fi
          else
            echo "docker/Dockerfile.csharp not found, skipping"
          fi

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-docker-monitor.sarif'
          category: 'trivy-docker-monitor'
        continue-on-error: true

      - name: Upload Docker scan results (Remediator)
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-docker-remediator.sarif'
          category: 'trivy-docker-remediator'
        continue-on-error: true

  code-security-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, csharp
          queries: security-and-quality

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
        continue-on-error: true

      - name: Build .NET project
        run: |
          if [ -d "csharp_remediator" ]; then
            cd csharp_remediator
            dotnet build --configuration Release || echo "Build failed but continuing"
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "codeql:python,csharp"
        continue-on-error: true

  bandit-security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit and SARIF tools
        run: |
          pip install bandit[toml]
          pip install sarif-om bandit2sarif

      - name: Run Bandit (JSON output)
        run: |
          if [ -d "python_monitor" ]; then
            bandit -r python_monitor/ -f json -o bandit-report.json || echo "Bandit scan completed with issues"
            bandit -r python_monitor/ -f txt -o bandit-report.txt || echo "Bandit scan completed with issues"
          else
            echo "python_monitor directory not found, creating empty reports"
            echo "{}" > bandit-report.json
            echo "No Python code found to scan" > bandit-report.txt
          fi

      - name: Convert Bandit to SARIF
        run: |
          if [ -f "bandit-report.json" ] && [ -s "bandit-report.json" ]; then
            bandit2sarif -o bandit.sarif bandit-report.json || echo "SARIF conversion failed"
          else
            echo "No Bandit results to convert to SARIF"
            echo '{"$schema": "https://schemastore.azurewebsites.net/schemas/json/sarif-2.1.0.json", "version": "2.1.0", "runs": []}' > bandit.sarif
          fi

      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit.sarif
          category: 'bandit'
        continue-on-error: true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: |
            bandit-report.json
            bandit-report.txt
            bandit.sarif
        if: always()

  semgrep-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/python
            p/csharp
          generateSarif: true
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: 'semgrep'
        if: always()
        continue-on-error: true

  docker-security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          if [ -f "docker/Dockerfile.python" ]; then
            docker build -f docker/Dockerfile.python -t eribot-monitor:security-scan . || echo "Python build failed"
          fi
          if [ -f "docker/Dockerfile.csharp" ]; then
            docker build -f docker/Dockerfile.csharp -t eribot-remediator:security-scan . || echo "C# build failed"
          fi

      - name: Run Docker Scout
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s -- || echo "Scout install failed"
          if docker images | grep -q eribot-monitor:security-scan; then
            docker scout cves eribot-monitor:security-scan --format sarif --output monitor-scout.sarif || echo "Monitor scout scan failed"
          fi
          if docker images | grep -q eribot-remediator:security-scan; then
            docker scout cves eribot-remediator:security-scan --format sarif --output remediator-scout.sarif || echo "Remediator scout scan failed"
          fi

      - name: Upload Scout results
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-results
          path: |
            monitor-scout.sarif
            remediator-scout.sarif
        if: always()
        continue-on-error: true

  openssf-scorecard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard Analysis
        uses: ossf/scorecard-action@v2.3.1
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          repo_token: ${{ secrets.SCORECARD_TOKEN }}
          publish_results: true

      - name: Upload Scorecard results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: scorecard-results.sarif
          category: 'scorecard'
        continue-on-error: true

      - name: Upload Scorecard results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: scorecard-results
          path: scorecard-results.sarif
        if: always()

  configuration-security-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets in config
        run: |
          echo "ðŸ” Checking configuration files for secrets..."
          if [ -d "config" ]; then
            if grep -r -i "password\|token\|secret\|key" config/ --exclude="*.example" --exclude="README*" 2>/dev/null; then
              echo "âš ï¸ WARNING: Hardcoded secrets found!"
              exit 1
            fi
          else
            echo "No config directory found, skipping config check"
          fi

          echo "ðŸ³ Checking Dockerfile security..."
          if [ -d "docker" ]; then
            if grep -q "USER root" docker/Dockerfile.* 2>/dev/null; then
              echo "âš ï¸ WARNING: Container running as root!"
            fi

            if ! grep -q "COPY --chown" docker/Dockerfile.* 2>/dev/null; then
              echo "ðŸ’¡ INFO: Consider using COPY --chown"
            fi
          else
            echo "No docker directory found, skipping Docker checks"
          fi

      - name: Check file permissions
        run: |
          echo "ðŸ” Checking sensitive file permissions..."
          find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" | while read file; do
            if [ -f "$file" ]; then
              perms=$(stat -c "%a" "$file")
              if [ "$perms" != "600" ] && [ "$perms" != "400" ]; then
                echo "âš ï¸ WARNING: $file has permissions $perms (should be 600 or 400)"
              fi
            fi
          done

      - name: Check for common security misconfigurations
        run: |
          echo "ðŸ” Checking for security misconfigurations..."
          
          # Check for debug mode in production configs
          if grep -r "debug.*true\|DEBUG.*True" config/ 2>/dev/null; then
            echo "âš ï¸ WARNING: Debug mode enabled in configuration"
          fi
          
          # Check for insecure protocols
          if grep -r "http://" config/ --include="*.yaml" --include="*.yml" --include="*.json" 2>/dev/null; then
            echo "âš ï¸ WARNING: Insecure HTTP protocol found in configuration"
          fi
          
          # Check for weak cipher suites (if any TLS config exists)
          if grep -r -i "ssl_cipher\|tls_cipher" config/ 2>/dev/null | grep -i "weak\|md5\|sha1\|rc4"; then
            echo "âš ï¸ WARNING: Weak cipher suites found"
          fi

  security-report:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - dependency-scan
      - secret-scan
      - vulnerability-scan
      - code-security-analysis
      - bandit-security-scan
      - semgrep-scan
      - docker-security-scan
      - openssf-scorecard
      - configuration-security-check
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Generate security summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md

          # Use needs context to check job results
          echo "| Scan Type | Status | Details |" >> security-summary.md
          echo "|-----------|--------|---------|" >> security-summary.md
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} | Python/C# dependency vulnerabilities |" >> security-summary.md
          echo "| Secret Scan | ${{ needs.secret-scan.result }} | TruffleHog secret detection |" >> security-summary.md
          echo "| Vulnerability Scan | ${{ needs.vulnerability-scan.result }} | Trivy filesystem and container scanning |" >> security-summary.md
          echo "| Code Security Analysis | ${{ needs.code-security-analysis.result }} | CodeQL static analysis |" >> security-summary.md
          echo "| Bandit Security Scan | ${{ needs.bandit-security-scan.result }} | Python security issues |" >> security-summary.md
          echo "| Semgrep Scan | ${{ needs.semgrep-scan.result }} | Multi-language security patterns |" >> security-summary.md
          echo "| Docker Security Scan | ${{ needs.docker-security-scan.result }} | Container image vulnerabilities |" >> security-summary.md
          echo "| OpenSSF Scorecard | ${{ needs.openssf-scorecard.result }} | Security best practices score |" >> security-summary.md
          echo "| Configuration Check | ${{ needs.configuration-security-check.result }} | Security configuration validation |" >> security-summary.md

          echo "" >> security-summary.md
          echo "## Next Steps" >> security-summary.md
          echo "" >> security-summary.md
          echo "1. **Review Security Tab**: Check GitHub Security tab for detailed findings" >> security-summary.md
          echo "2. **Fix Critical Issues**: Address any high/critical severity vulnerabilities" >> security-summary.md
          echo "3. **Update Dependencies**: Ensure all dependencies are up to date" >> security-summary.md
          echo "4. **Review Configuration**: Validate security configurations" >> security-summary.md
          echo "5. **Monitor Alerts**: Set up notifications for new security alerts" >> security-summary.md
          
          echo "" >> security-summary.md
          echo "## Artifacts Generated" >> security-summary.md
          echo "" >> security-summary.md
          echo "- \`dependency-scan-results\`: Vulnerability reports for Python and C# dependencies" >> security-summary.md
          echo "- \`bandit-results\`: Python security analysis results" >> security-summary.md
          echo "- \`docker-scout-results\`: Container security scan results" >> security-summary.md
          echo "- \`scorecard-results\`: OpenSSF security scorecard" >> security-summary.md
          
          echo "" >> security-summary.md
          echo "---" >> security-summary.md
          echo "*Generated by EriBot Security Workflow*" >> security-summary.md
          
          cat security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Security Scan Results\n\n${summary}`
            });
        continue-on-error: true